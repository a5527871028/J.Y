<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ç¿Šç¾å­¸ Ã— J.Y Beauty Studio</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (éˆ´éºã€IGã€LINEç­‰åœ–ç¤º) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce7f3; /* æ·ºç²‰è‰²èƒŒæ™¯ */
            /* è–èª•ä¸»é¡ŒèƒŒæ™¯åœ–æ¡ˆï¼šä½¿ç”¨ç·šæ€§æ¼¸è®Šå’Œé‡è¤‡æ”¾å°„æ€§æ¼¸è®Šæ¨¡æ“¬æº«æš–é›ªèŠ± */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 1px, transparent 1px),
                radial-gradient(circle at 60% 80%, rgba(255, 255, 255, 0.5) 1px, transparent 1px),
                radial-gradient(circle at 80% 40%, rgba(255, 255, 255, 0.5) 0.5px, transparent 0.5px),
                linear-gradient(180deg, #fff7ed 0%, #fce7f3 100%);
            background-repeat: repeat, repeat, repeat, no-repeat;
            background-size: 100% 100%, 100% 100%, 100% 100%, cover;
            min-height: 100vh;
        }

        .card-container {
            max-width: 768px;
        }

        /* è‡ªå®šç¾©æŒ‰éˆ•é¢¨æ ¼ */
        .btn-primary {
            @apply bg-[#f06292] text-white hover:bg-[#e91e63] font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-300;
        }

        /* é …ç›®åˆ—è¡¨é¢¨æ ¼ */
        .list-item {
            @apply flex items-start space-x-2 py-2 border-b border-pink-100;
        }
        .list-icon {
            @apply text-pink-600 flex-shrink-0 mt-1;
        }

        /* åƒ¹ç›®è¡¨è¡¨æ ¼æ¨£å¼ */
        .price-table {
            @apply w-full text-sm text-gray-700;
        }
        .price-table th, .price-table td {
            @apply px-2 py-2 text-center border-b border-pink-200;
        }
        .price-table th {
            @apply bg-pink-100 font-bold text-pink-700 text-base;
        }
        .price-table tr:last-child td {
            @apply border-b-0;
        }
        
        .tab-button {
            @apply text-sm sm:text-base font-medium py-3 px-3 sm:px-4 text-gray-600 transition duration-300 whitespace-nowrap rounded-t-xl hover:bg-white hover:text-pink-600;
        }
        .tab-button.active {
            @apply bg-white text-pink-700 shadow-inner shadow-pink-100;
        }

        /* éš±è—å¯†ç¢¼è¼¸å…¥çš„å¯¦éš›æ–‡å­— */
        .password-input {
            -webkit-text-security: disc;
            text-security: disc;
        }
        
        /* ç®¡ç†å“¡ä»‹é¢å€å¡Šæ¨™é¡Œ */
        .admin-section-title {
            @apply text-lg font-bold text-pink-700 border-l-4 border-pink-500 pl-3 mb-4 mt-6;
        }
    </style>
</head>
<body class="p-4 sm:p-6 flex justify-center">

    <div id="loading-overlay" class="fixed inset-0 bg-pink-500/50 flex justify-center items-center z-50">
        <div class="text-white text-xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>è¼‰å…¥ä¸­...</span>
        </div>
    </div>
    
    <div id="main-content" class="card-container w-full bg-white rounded-3xl shadow-2xl p-4 sm:p-8 relative hidden">
        
        <!-- ç®¡ç†å“¡ç™»å…¥æŒ‰éˆ• -->
        <button id="admin-login-btn" class="absolute top-4 right-4 text-gray-500 hover:text-pink-600 transition duration-150 p-2 rounded-full bg-pink-50 hover:bg-pink-100" onclick="showLoginModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 1 1 12 0c0 7-3 9-3 9H9s-3-2-3-9"/><path d="M10.375 18a2 2 0 1 0 3.25 0"/></svg>
        </button>
        
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-pink-700 tracking-wider">
                ä¹ç¿Šç¾å­¸ Ã— J.Y Beauty Studio
            </h1>
            <p class="text-pink-500 font-semibold mt-1">å°å— æ°¸åº·å€</p>
            
            <!-- ç¤¾äº¤åª’é«”æŒ‰éˆ• -->
            <div class="flex justify-center space-x-4 mt-4 mb-6">
                <!-- Instagram -->
                <a href="https://www.instagram.com/jystudio_1210?igsh=MWQ3czM4bHRqd2FmZw==" target="_blank" class="p-3 rounded-full shadow-md transition duration-300 transform hover:scale-110" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.75C7.94 4.75 4.75 7.94 4.75 12s3.19 7.25 7.25 7.25 7.25-3.19 7.25-7.25S16.06 4.75 12 4.75zm0 13a5.25 5.25 0 100-10.5 5.25 5.25 0 000 10.5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.5 7.5h.01"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.5 7.5h.01"/></svg>
                </a>
                
                <!-- LINE -->
                <a href="https://lin.ee/gRA18AK" target="_blank" class="p-3 rounded-full bg-green-500 shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-110">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.028 2.016c-5.523 0-10.007 4.475-10.007 9.998 0 5.097 3.793 9.324 8.708 9.878v-6.958H8.868V11.05H11.02V8.95c0-2.188 1.309-3.385 3.295-3.385 0.945 0 1.76.07 1.996.1v2.308h-1.378c-1.09 0-1.303 0.518-1.303 1.282v1.688h2.64l-0.457 2.628h-2.183v6.958c4.915-0.554 8.708-4.781 8.708-9.878 0-5.523-4.484-9.998-10.007-9.998z"/></svg>
                </a>
            </div>
        </header>

        <!-- é ç±¤/åˆ†é å°èˆª -->
        <div class="border-b border-pink-200 sticky top-0 bg-white z-10 rounded-t-xl">
            <div class="flex overflow-x-auto whitespace-nowrap -mb-px">
                <button class="tab-button active" data-tab="rules" onclick="changeTab('rules')">é ç´„é ˆçŸ¥</button>
                <button class="tab-button" data-tab="prices" onclick="changeTab('prices')">åƒ¹ç›®è¡¨</button>
                <button class="tab-button" data-tab="qa" onclick="changeTab('qa')">Q&A</button>
                <button class="tab-button" data-tab="events" onclick="changeTab('events')">æœ¬æœˆæ´»å‹•</button>
                <button class="tab-button" data-tab="booking" onclick="changeTab('booking')">é ç´„è¡¨å–®</button>
                <button id="admin-schedule-tab" class="tab-button hidden" data-tab="schedule" onclick="changeTab('schedule')">é ç´„æ™‚åˆ»è¡¨</button>
            </div>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div id="tab-content" class="bg-white p-4 sm:p-6 rounded-b-3xl min-h-[500px] shadow-inner border border-t-0 border-pink-200">
            <!-- å…§å®¹æœƒç”± JavaScript å‹•æ…‹è¼‰å…¥/ç”Ÿæˆ -->
        </div>
        
        <!-- åº•éƒ¨è²æ˜ -->
        <footer class="text-center mt-8 text-xs text-gray-500 p-2 border-t border-pink-100">
            æœ¬åº—æ“æœ‰åº—å…§è¦å‰‡åŠæ´»å‹•ä¹‹æœ€çµ‚è§£é‡‹æ¬Š
            <p id="footer-user-id" class="text-gray-400 mt-1 text-[10px]"></p>
        </footer>
    </div>
    
    <!-- ç®¡ç†å“¡ç™»å…¥å½ˆå‡ºè¦–çª— (Modal) -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h2 class="text-2xl font-bold text-pink-600 mb-4">ç®¡ç†å“¡ç™»å…¥</h2>
            <div id="login-message" class="mb-4 text-red-500 font-medium hidden"></div>
            
            <div class="mb-4">
                <label for="admin-username" class="block text-sm font-medium text-gray-700">å¸³è™Ÿ:</label>
                <input type="text" id="admin-username" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-pink-500 focus:border-pink-500" value="a5527871028" required>
            </div>
            <div class="mb-6">
                <label for="admin-password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼:</label>
                <!-- ä½¿ç”¨ password-input class é€²è¡Œè¦–è¦ºéš±è— -->
                <input type="password" id="admin-password" class="password-input mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-pink-500 focus:border-pink-500" value="apple5512" required>
            </div>
            
            <div class="flex justify-between space-x-4">
                <button type="button" onclick="hideLoginModal()" class="w-1/2 py-2 text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-100 transition duration-150">å–æ¶ˆ</button>
                <button type="submit" onclick="attemptAdminLogin()" class="w-1/2 btn-primary">ç™»å…¥</button>
            </div>
        </div>
    </div>
    
    <!-- è¨Šæ¯æç¤ºè¦–çª— (Custom Alert/Confirm) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h3 id="message-modal-title" class="text-xl font-bold text-pink-600 mb-3">è¨Šæ¯</h3>
            <p id="message-modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button type="button" onclick="hideMessageModal()" class="py-2 px-4 btn-primary">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­å®šæ—¥èªŒç´šåˆ¥ç‚º Debug
        setLogLevel('Debug');

        // å…¨å±€è®Šæ•¸
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAdmin = false;
        window.loginAttempts = 0;
        window.maxLoginAttempts = 3;
        window.activeTab = 'rules';
        
        // Firestore é›†åˆå’Œæ–‡ä»¶è·¯å¾‘
        const APPOINTMENT_CONFIG_COLLECTION = 'appointment_config';
        const APPOINTMENT_COLLECTION = 'appointments';
        const RULES_DOC = 'rules';
        const EVENTS_DOC = 'events';

        // å„²å­˜çš„å…§å®¹ç‹€æ…‹
        window.rulesData = {
            rules: "",
            attention: ""
        };
        window.eventsData = "";
        window.appointments = [];

        // --- Utility Functions ---

        /** é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯è¦–çª— */
        window.showMessageModal = (title, body) => {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-body').textContent = body;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        };

        /** éš±è—è‡ªå®šç¾©è¨Šæ¯è¦–çª— */
        window.hideMessageModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        };

        /** é¡¯ç¤ºç™»å…¥è¦–çª— */
        window.showLoginModal = () => {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('flex');
        };

        /** éš±è—ç™»å…¥è¦–çª— */
        window.hideLoginModal = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('flex');
            // è¶…éå˜—è©¦æ¬¡æ•¸ä¹Ÿè¿”å›ä¸»é é¢
            if (window.loginAttempts >= window.maxLoginAttempts) {
                window.loginAttempts = 0;
                window.showMessageModal('æç¤º', 'ç™»å…¥å˜—è©¦éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        };

        /** æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD */
        window.formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Firebase Core Functions ---

        /** åˆå§‹åŒ– Firebase */
        async function initFirebase() {
            try {
                if (window.app) return;
                
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // èªè­‰ç›£è½å™¨
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('footer-user-id').textContent = `User ID: ${window.userId}`;
                        // æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹ (å¾ sessionStorage æ¢å¾©)
                        window.isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                        
                        // åˆå§‹åŒ–å…§å®¹
                        await initializeContent();
                        
                        // å•Ÿå‹•å¿«ç…§ç›£è½
                        setupFirestoreListeners();
                        
                        // åˆå§‹æ¸²æŸ“
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        changeTab(window.activeTab); // é¦–æ¬¡æ¸²æŸ“å…§å®¹
                    } else {
                        // é¦–æ¬¡è¼‰å…¥æˆ–ç™»å‡ºï¼Œé€²è¡Œèªè­‰
                        try {
                            if (window.initialAuthToken) {
                                await signInWithCustomToken(window.auth, window.initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                        } catch (e) {
                            console.error("Firebase Auth failed:", e);
                            window.showMessageModal('éŒ¯èª¤', 'Firebase èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                window.showMessageModal('éŒ¯èª¤', `Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }

        /** è¨­ç½® Firestore å¯¦æ™‚ç›£è½ (onSnapshot) */
        function setupFirestoreListeners() {
            if (!window.userId) return;

            // 1. é ç´„é ˆçŸ¥ç›£è½
            const rulesRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, RULES_DOC);
            onSnapshot(rulesRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.rulesData = docSnap.data();
                    if (window.activeTab === 'rules') renderContent('rules');
                }
            });

            // 2. æœ¬æœˆæ´»å‹•ç›£è½
            const eventsRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, EVENTS_DOC);
            onSnapshot(eventsRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.eventsData = docSnap.data().content || '';
                    if (window.activeTab === 'events') renderContent('events');
                }
            });
            
            // 3. é ç´„è³‡æ–™ç›£è½
            const appointmentsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_COLLECTION);
            const q = query(appointmentsColRef);
            onSnapshot(q, (snapshot) => {
                window.appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.activeTab === 'booking') renderContent('booking');
                if (window.activeTab === 'schedule') renderContent('schedule');
            });

            // é¡¯ç¤ºæˆ–éš±è—ç®¡ç†å“¡åˆ†é 
            updateAdminUI();
        }

        /** æª¢æŸ¥ä¸¦åˆå§‹åŒ–é è¨­å…§å®¹ */
        async function initializeContent() {
            const rulesRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, RULES_DOC);
            const eventsRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, EVENTS_DOC);

            // é ç´„é ˆçŸ¥é è¨­å…§å®¹
            const defaultRules = {
                rules: `1. é™ç”Ÿç†å¥³ã€ç”·è³“æ­¢æ­¥
2. æ—¥é–“åŠé ç´„åˆ¶
3. æ—¥é–“æ™‚æ®µï¼š10ï½17é»ï¼›å¤œé–“æ™‚æ®µï¼š18ï½3é»
4. é ç´„æ—¥é–“ä¸ç”¨è¨‚é‡‘ï¼Œä½†æœ‰æœªåˆ°ç´€éŒ„ï¼Œä¸‹æ¬¡é ç´„é ˆå…ˆåŒ¯æ¬¾è¨‚é‡‘ï¼ˆç‚ºé ç´„é …ç›®ç¸½åƒ¹1/2ä¹‹é‡‘é¡ï¼‰
5. é ç´„å¤œé–“çš†éœ€å…ˆä»˜æ¬¾è¨‚é‡‘ï¼ˆç‚ºé ç´„é …ç›®ç¸½åƒ¹1/2ä¹‹é‡‘é¡ï¼‰
6. é²åˆ°15åˆ†é˜ä»¥ä¸Šï¼Œæœªå…ˆè¨Šæ¯å‘ŠçŸ¥å³è¦–ç‚ºæœªåˆ°ï¼Œä¸¦å–æ¶ˆé ç´„
7. å–æ¶ˆé ç´„è‡³å°‘æå‰ä¸‰å¤©ï¼Œå¦‚æœ‰åŒ¯æ¬¾è¨‚é‡‘æ–¹å¯å…¨é¡é€€é‚„
8. å› åˆä½œç©ºé–“ï¼Œæ–½ä½œç©ºé–“ç‚ºå¸ƒç°¾éš”æ–·éš”éŸ³ï¼Œé›–é™¤æ¯›å¸«äººéƒ½æœƒåœ¨ï¼Œä½†ä»‹æ„å‹¿ç´„
9. ç¾å®¹ç©ºé–“ç„¡æ³•æ”œå¸¶é£Ÿç‰©åŠå¯µç‰©`,
                attention: `1. æ–½ä½œæ—¥å‰è«‹åœç”¨é…¸é¡ç”¢å“ã€åœæ­¢å»è§’è³ªè‡³å°‘ä¸€é€±ï¼Œé¿å…è‚Œè†šéæ•æˆ–åˆºæ¿€
2. æ¯›é«®é•·åº¦éœ€è‡³å°‘ 0.5 è‡³ 1 å…¬åˆ†ï¼Œè«‹å‹¿è‡ªè¡Œä¿®å‰ªï¼Œä»¥å…å½±éŸ¿é™¤æ¯›æ•ˆæœ
3. é¿é–‹ç”Ÿç†æœŸå‰ 5 å¤©åˆ°å¾Œ 3 å¤©
4. è‹¥æœ‰è¦åŠƒå‡ºéŠï¼Œå»ºè­°æå‰3ï½5å¤©å®‰æ’é™¤æ¯›æ™‚é–“ï¼Œè®“è‚Œè†šæœ‰è¶³å¤ çš„æ™‚é–“æ¢å¾©ï¼Œé¿å…åœ¨å‡ºéŠå‰ä¸€å…©å¤©æ‰é™¤æ¯›
5. é™¤æ¯›å‰å¾Œè«‹å‹¤å‹å¯†é›†ä¿æ¿•ï¼Œé™¤æ¯›æ™‚æœ‰è„«çš®ã€æ³›ç´…ã€ç´…é»å±¬æ­£å¸¸ç¾è±¡ï¼Œè«‹æ³¨æ„ç”¢å“ä¸èƒ½å«é…¸ã€ä¹Ÿæ²’æœ‰ç¾ç™½åŠŸèƒ½`
            };

            // æœ¬æœˆæ´»å‹•é è¨­å…§å®¹
            const defaultEvents = `* æ•´å€‹æœˆéƒ½äº«æœ‰é–‹å¹•åƒ¹
* å­¸ç”Ÿåƒ¹æ´»å‹•éå¾Œä¸æœƒæ¶ˆå¤±
* åˆ†äº«LINEå®˜æ–¹çµ¦å¥½å‹ï¼Œä¸€èµ·åŠ å¥½å‹å…©äººéƒ½èƒ½æ‹¿åˆ°å„ªæƒ åŠµï¼Œä¸€äººæœ€é«˜å¯æ‹¿äº”å¼µï¼Œæ¯æ¬¡å¯ä½¿ç”¨1å¼µ
* è¿½è¹¤IGã€åŠ LINEå®˜æ–¹ã€Googleè©•è«–äº”é¡†æ˜Ÿä¸¦ç•™è¨€ï¼Œç¶“å®šé¡æŠ˜æ‰£å®Œï¼Œæ¶ˆè²»ç¸½é¡å†æ‰“ä¹æŠ˜`;

            try {
                // æª¢æŸ¥ä¸¦è¨­å®šé ç´„é ˆçŸ¥
                const rulesSnap = await getDoc(rulesRef);
                if (!rulesSnap.exists()) {
                    await setDoc(rulesRef, defaultRules);
                }

                // æª¢æŸ¥ä¸¦è¨­å®šæœ¬æœˆæ´»å‹•
                const eventsSnap = await getDoc(eventsRef);
                if (!eventsSnap.exists()) {
                    await setDoc(eventsRef, { content: defaultEvents });
                }
            } catch (e) {
                console.warn("Error setting initial data:", e);
            }
        }

        // --- Admin Functions ---

        /** å˜—è©¦ç®¡ç†å“¡ç™»å…¥ */
        window.attemptAdminLogin = () => {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const msgEl = document.getElementById('login-message');
            msgEl.classList.add('hidden');

            const ADMIN_USER = 'a5527871028';
            const ADMIN_PASS = 'apple5512';

            if (window.loginAttempts >= window.maxLoginAttempts -1) {
                window.loginAttempts++;
                hideLoginModal();
                return;
            }

            if (username === ADMIN_USER && password === ADMIN_PASS) {
                window.isAdmin = true;
                sessionStorage.setItem('isAdmin', 'true'); // å­˜å„²ç‹€æ…‹
                window.loginAttempts = 0;
                hideLoginModal();
                updateAdminUI();
                renderContent(window.activeTab);
                window.showMessageModal('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥ç®¡ç†å“¡æ¨¡å¼ï¼');
            } else {
                window.loginAttempts++;
                msgEl.textContent = 'è«‹ç¢ºå®šå¸³å¯†æˆ–èˆ‡ç®¡ç†å“¡è¯ç¹«';
                msgEl.classList.remove('hidden');
                
                if (window.loginAttempts >= window.maxLoginAttempts) {
                    hideLoginModal();
                }
            }
        };

        /** æ›´æ–°ç®¡ç†å“¡ä»‹é¢å…ƒç´  */
        function updateAdminUI() {
            const adminScheduleTab = document.getElementById('admin-schedule-tab');
            if (window.isAdmin) {
                adminScheduleTab.classList.remove('hidden');
            } else {
                adminScheduleTab.classList.add('hidden');
                if (window.activeTab === 'schedule') changeTab('rules'); // å¦‚æœç®¡ç†å“¡ç™»å‡ºï¼Œè‡ªå‹•åˆ‡æ›åˆ°ç¬¬ä¸€å€‹åˆ†é 
            }
        }

        /** å„²å­˜é ç´„é ˆçŸ¥å…§å®¹ */
        window.saveRules = async () => {
            const rules = document.getElementById('edit-rules-content').value;
            const attention = document.getElementById('edit-attention-content').value;
            
            const rulesRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, RULES_DOC);
            
            try {
                await setDoc(rulesRef, { rules, attention });
                window.showMessageModal('å„²å­˜æˆåŠŸ', 'é ç´„é ˆçŸ¥å·²æ›´æ–°ï¼');
                // Firestore ç›£è½å™¨æœƒè‡ªå‹•æ›´æ–° window.rulesData å’Œ UI
                renderContent('rules');
            } catch (e) {
                console.error("Save rules failed:", e);
                window.showMessageModal('éŒ¯èª¤', 'å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
            }
        };

        /** å„²å­˜æœ¬æœˆæ´»å‹•å…§å®¹ */
        window.saveEvents = async () => {
            const content = document.getElementById('edit-events-content').value;
            
            const eventsRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_CONFIG_COLLECTION, EVENTS_DOC);
            
            try {
                await setDoc(eventsRef, { content });
                window.showMessageModal('å„²å­˜æˆåŠŸ', 'æœ¬æœˆæ´»å‹•å·²æ›´æ–°ï¼');
                // Firestore ç›£è½å™¨æœƒè‡ªå‹•æ›´æ–° window.eventsData å’Œ UI
                renderContent('events');
            } catch (e) {
                console.error("Save events failed:", e);
                window.showMessageModal('éŒ¯èª¤', 'å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
            }
        };
        
        // --- Content Rendering Functions ---

        /** æ¸²æŸ“é ç´„é ˆçŸ¥å…§å®¹ (Admin ç·¨è¼¯æ¨¡å¼æˆ–æ™®é€šé¡¯ç¤º) */
        function renderRulesContent() {
            const { rules = '', attention = '' } = window.rulesData;
            let html = '';

            const listToHtml = (text, title) => {
                const items = text.split('\n').filter(line => line.trim() !== '');
                return `
                    <div class="mb-6 p-4 bg-pink-50 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-pink-600 mb-3 border-b border-pink-200 pb-1">${title}</h3>
                        <ul class="space-y-2">
                            ${items.map(item => `
                                <li class="list-item">
                                    <span class="list-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.928 3.864L7 7.042l3.072 1.178L12 12l1.928-3.864 3.072-1.178-3.072-1.178z"/><path d="m17.5 14.5-1.428 2.864L13 18.042l3.072 1.178L17.5 23l1.928-3.864 3.072-1.178-3.072-1.178z"/></svg>
                                    </span>
                                    <span class="text-gray-700">${item.substring(item.indexOf('.') + 1).trim()}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            };

            if (window.isAdmin) {
                // ç®¡ç†å“¡ç·¨è¼¯æ¨¡å¼
                html = `
                    <h2 class="admin-section-title">ç·¨è¼¯é ç´„é ˆçŸ¥</h2>
                    
                    <div class="mb-8">
                        <label for="edit-rules-content" class="block text-lg font-semibold text-pink-700 mb-2">åº—å…§è¦å‰‡ (æ¯è¡Œä¸€å€‹é …ç›®):</label>
                        <textarea id="edit-rules-content" rows="10" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-pink-500 focus:border-pink-500">${rules}</textarea>
                    </div>

                    <div class="mb-8">
                        <label for="edit-attention-content" class="block text-lg font-semibold text-pink-700 mb-2">æ–½ä½œå‰æ³¨æ„ (æ¯è¡Œä¸€å€‹é …ç›®):</label>
                        <textarea id="edit-attention-content" rows="10" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-pink-500 focus:border-pink-500">${attention}</textarea>
                    </div>
                    
                    <button onclick="saveRules()" class="btn-primary w-full sm:w-auto">å„²å­˜æ›´æ”¹</button>
                    <p class="text-sm text-gray-500 mt-2">è«‹ç¢ºä¿æ¯å€‹é …ç›®éƒ½ä»¥ "1. " æˆ– "2. " ç­‰æ•¸å­—é–‹é ­ï¼Œä¾¿æ–¼æ’ç‰ˆè§£æã€‚</p>
                `;
            } else {
                // æ™®é€šé¡¯ç¤ºæ¨¡å¼
                html = listToHtml(rules, 'åº—å…§è¦å‰‡');
                html += listToHtml(attention, 'æ–½ä½œå‰æ³¨æ„');
            }

            document.getElementById('tab-content').innerHTML = html;
        }

        /** æ¸²æŸ“åƒ¹ç›®è¡¨å…§å®¹ */
        function renderPricesContent() {
            const pricingData = [
                { category: 'ç§å¯†è™•', items: [
                    { name: 'æ¯”åŸºå°¼é™¤æ¯›', original: 1000, open: 899, student: 799 },
                    { name: 'å·´è¥¿å¼å…¨é™¤', original: 1500, open: 1299, student: 999 },
                ]},
                { category: 'æ‰‹éƒ¨', items: [
                    { name: 'è…‹ä¸‹', original: 600, open: 499, student: 399 },
                    { name: 'ä¸Š/ä¸‹æ‰‹è‡‚', original: 800, open: 699, student: 499 },
                    { name: 'å…¨æ‰‹è‡‚', original: 1200, open: 1099, student: 899 },
                    { name: 'æ‰‹æŒ‡', original: 400, open: 299, student: 199 },
                ]},
                { category: 'è…¿éƒ¨', items: [
                    { name: 'å°è…¿', original: 1000, open: 899, student: 699 },
                    { name: 'å¤§è…¿', original: 1200, open: 1099, student: 799 },
                    { name: 'å…¨è…¿', original: 1600, open: 1399, student: 1099 },
                    { name: 'è†è“‹', original: 400, open: 199, student: 150 },
                ]},
                { category: 'å…¶ä»–éƒ¨ä½', items: [
                    { name: 'è‚šå­', original: 1300, open: 1099, student: 799 },
                    { name: 'ä¸Š/ä¸‹èƒŒ', original: 900, open: 699, student: 599 },
                    { name: 'å…¨èƒŒ', original: 1400, open: 1099, student: 899 },
                ]},
            ];

            let html = `
                <h2 class="text-2xl font-extrabold text-pink-700 mb-4 text-center">ç†±è Ÿé™¤æ¯›</h2>
                <p class="text-lg font-semibold text-pink-500 mb-6 text-center">ä½¿ç”¨ italwax ç¾©æœµç†±è Ÿ</p>
            `;

            pricingData.forEach(section => {
                html += `
                    <div class="mb-8 p-4 bg-white rounded-xl shadow-lg border border-pink-100">
                        <h3 class="text-xl font-bold text-pink-600 mb-4 border-l-4 border-pink-500 pl-3">${section.category}</h3>
                        <div class="overflow-x-auto">
                            <table class="price-table">
                                <thead>
                                    <tr>
                                        <th class="text-left w-1/4">é …ç›®</th>
                                        <th class="w-1/4">åŸåƒ¹</th>
                                        <th class="w-1/4 bg-red-100 text-red-600">é–‹å¹•åƒ¹</th>
                                        <th class="w-1/4 bg-yellow-100 text-yellow-700">å­¸ç”Ÿåƒ¹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${section.items.map(item => `
                                        <tr>
                                            <td class="text-left font-medium text-pink-800">${item.name}</td>
                                            <td>$${item.original}</td>
                                            <td class="font-bold text-red-600">$${item.open}</td>
                                            <td class="font-bold text-yellow-700">$${item.student}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            html += `
                <div class="mt-8 text-sm text-gray-500 bg-pink-50 p-4 rounded-xl space-y-2">
                    <p>âœ¨ ä¸Šè¿°é–‹å¹•åƒ¹åªé™é–‹å¹•é«”é©—æœˆæœ‰è€Œå·²ï¼Œæ´»å‹•çµæŸæ¢å¾©åŸåƒ¹ã€‚</p>
                    <p>âœ¨ é–‹å¹•åƒ¹åŠå­¸ç”Ÿåƒ¹éƒ½ç¬¦åˆè³‡æ ¼æ“‡ä¸€åƒåŠ ã€‚</p>
                    <p>âœ¨ å­¸ç”Ÿå‡ºç¤ºå¯¦é«”å¡ä¸¦åŠ å…¥å®˜æ–¹ LINE æ–¹å¯äº«å­¸ç”Ÿåƒ¹å„ªæƒ ï¼Œå¯åƒåŠ é–‹å¹•æœˆæŠ˜ä¸ŠæŠ˜æ´»å‹•ã€‚</p>
                </div>
            `;
            document.getElementById('tab-content').innerHTML = html;
        }

        /** æ¸²æŸ“ Q&A å…§å®¹ */
        function renderQAContent() {
            const qaData = [
                { category: 'æ´»å‹•', items: [
                    { q: 'é–‹å¹•æœˆæœŸé–“ç‚ºä½•æ™‚ï¼Ÿ', a: 'æ•´å€‹ 12 æœˆéƒ½æ˜¯å–”ï¼' },
                    { q: 'æŠ˜ä¸ŠæŠ˜æ´»å‹•æ˜¯ä»€éº¼æ„æ€ï¼Ÿ', a: 'é–‹å¹•æœˆåªè¦ä½ æœ‰å„ªæƒ å·æˆ–ç¬¦åˆä»»ä¸€è³‡æ ¼æŠ˜æ‰£ï¼Œä¸”å–®ç­†æ¶ˆè²»é‡‘é¡æ»¿äº”ç™¾ä»¥ä¸Šï¼Œéƒ½å¯ä»¥ä½µè¡Œä½¿ç”¨ã€‚' },
                    { q: 'æ´»å‹•å¥½å¤šæˆ‘æœ‰é»æ··äº‚ã€‚', a: 'å¯ä»¥åƒè€ƒå³ä¸Šæ–¹ã€Œæœ¬æœˆæ´»å‹•ã€é é¢è³‡è¨Šï¼Œæœ‰é€™å€‹æœˆæ´»å‹•è©³è¿°ã€‚' },
                ]},
                { category: 'é ç´„', items: [
                    { q: 'åŠé ç´„åˆ¶ä»€éº¼æ„æ€ï¼Ÿä½ å€‘ç‡Ÿæ¥­ 24 å°æ™‚å—ï¼Ÿ', a: 'å¸Œæœ›ä½ å€‘æå‰ç´„ï¼Œä½†åœ¨æ—¥é–“æ™‚æ®µ (10~17 é») å¯ä»¥è‡´é›»è©¢å•ç•¶å¤©é‚„æœ‰æ²’æœ‰æ™‚é–“æ®µï¼Œå¦‚æœæœ‰é‚„æ˜¯å¯ä»¥å‰ä¾†æ–½ä½œï¼›å¤œé–“æ™‚æ®µ (18~3 é») è‡³å°‘ä¸‰å¤©å‰å°±éœ€è¦ç´„ã€‚' },
                    { q: 'æˆ‘æƒ³é ç´„ï¼Œæ‡‰è©²æ€éº¼åšï¼Ÿ', a: 'æ—¥é–“æ™‚æ®µ (10~17 é») LINE éƒ½å¯ä»¥é ç´„å–”ã€‚' },
                    { q: 'è«‹å•å¦‚æœæˆ‘ä¾†ä¸åŠåœ¨é ç´„æ—¥ä¸‰å¤©å‰å–æ¶ˆæ€éº¼è¾¦ï¼Ÿ', a: 'ä¸‹æ¬¡é ç´„å¯ä»¥å…ˆç§è¨Šï¼Œå®Œæˆè¨‚é‡‘åŒ¯æ¬¾å°±æœƒå¹«ä½ é ç´„ã€‚' },
                    { q: 'æˆ‘æœªåˆ°ä¸€æ¬¡ï¼Œå†æ¬¡é ç´„åˆæ˜¯ä¸‰å¤©å…§å–æ¶ˆï¼Œæ˜¯ä¸æ˜¯è¨‚é‡‘å°±è¢«åƒæ‰äº†ï¼Ÿ', a: 'æ˜¯çš„ï¼Œé€™æ¨£è¡¨ç¤ºæœªåˆ°å…©æ¬¡ï¼Œå…©å€‹æ™‚é–“æ®µéƒ½å·²ç¶“ç‚ºæ‚¨å®‰æ’ã€‚' },
                ]},
                { category: 'J.Y ç‰¹åˆ¥åŠ è³¼é …ç›®ï¼šè‡¨æ‰˜æœå‹™', items: [
                    { q: 'æˆ‘æƒ³é™¤æ¯›æ™‚ï¼Œé ç´„è‡¨æ™‚æ‰˜è‚²æœå‹™ï¼Œå¯ä»¥å—ï¼Ÿæœ‰æ²’æœ‰ä»€éº¼é™åˆ¶ï¼Ÿ', a: 'æš«æ™‚ä¸é–‹æ”¾ï¼Œä¹‹å¾Œåƒ…é–‹æ”¾å¤œé–“æ™‚æ®µè‡¨æ‰˜ï¼Œå¹´é½¡é™åˆ¶ 5 æ­²ä»¥ä¸‹ï¼Œä¸”ä¹Ÿéœ€è¦çœ‹ä¿æ¯å®‰æ’ï¼Œå¦‚æœå¯ä»¥æ¥å—è«‹å…ˆåŠ æˆ‘å€‘ LINEï¼Œç§è¨Šã€Œæˆ‘æƒ³åŠ è³¼æ‰˜è‚²ã€ï¼Œæœå‹™äººå“¡æœƒå›è¦†å¦³åƒ¹æ ¼åŠæ™‚æ®µã€‚' },
                    { q: 'è‡¨æ™‚æ‰˜è‚²æœå‹™æ˜¯å°ˆæ¥­äººå“¡å—ï¼Ÿ', a: 'æ˜¯ï¼Œæœ‰æ°¸åº·å€å±…å®¶æ‰˜è‚²è­‰ç…§ï¼ŒåŠ å…¥æº–å…¬æ‰˜è€Œä¸”æ˜¯ç›¸é—œç§‘ç³»ã€‚' },
                    { q: 'æˆ‘åŠ è³¼è‡¨æ™‚æ‰˜è‚²æœå‹™çœ‹å¾—åˆ°å°å­©å—ï¼Ÿ', a: 'é€šå¸¸çœ‹ä¸åˆ°ï¼Œä½†å°å­©å°±åœ¨äºŒæ¨“è€Œå·²ï¼Œè€Œå¦³åœ¨ä¸€æ¨“æ–½ä½œã€‚å¦‚æœè¦çœ‹åˆ°å¯ä»¥å¦å¤–äº‹å…ˆæå‡ºã€‚' },
                    { q: 'æ²’åŠ è³¼è‡¨æ‰˜å¯ä»¥å¸¶å°å­©å»å—ï¼Ÿ', a: 'æ²’è¾¦æ³•å–”ï¼Œå› æ–½ä½œæ™‚ç’°å¢ƒéœ€è¦å®‰éœã€ä¹Ÿæ¯”è¼ƒä¸èƒ½è¢«å‹•å½ˆã€‚' },
                ]},
                { category: 'ç†±è Ÿ', items: [
                    { q: 'ç†±è Ÿé™¤æ¯›å¥½è™•ï¼Ÿ', a: 'é™¤æ¯›æ•ˆæœä¾å€‹äººé«”è³ªç´„ç¶­æŒä¸‰~ä¸ƒé€±ï¼Œä¸¦ä¸”é€£æ ¹æ‹”é™¤éç¨‹ä¸­å› ç ´å£æ¯›å›Šï¼Œé•·æœŸå›ºå®šå›é™¤èƒ½ä½¿æ¯›é«®è®Šç´°ã€è®Šå°‘ï¼Œç”Ÿé•·é€Ÿåº¦ä¹Ÿæœƒè®Šæ…¢ã€‚' },
                    { q: 'ç‚ºä»€éº¼é™¤æ¯›å®Œæœƒè®Šç™½ï¼Ÿ', a: 'å› ç‚ºç†±è Ÿé™„å¸¶å»é™¤è€å»¢è§’è³ªï¼Œä¹Ÿæœ‰é«”é©—å®¢å› ç‚ºé€™æ¨£é™¤å…¨èº«ç†±è Ÿå–”ï¼(å…¨èº«ç†±è Ÿéœ€é ç´„æ•´å¤©å–”)' },
                    { q: 'æœƒä¸æœƒå¾ˆç‡™æˆ–å¾ˆç—›ï¼Ÿ', a: 'æœ¬åº—ä½¿ç”¨ italwax ç¾©æœµç†±è Ÿï¼Œä¸æœƒå¾ˆç‡™ï¼Œä¹‹æ–¼ä¸€èˆ¬ç†±è Ÿæ¸›ç—›éå¸¸å¤šï¼Œä½†ä¾æ“šå€‹äººæ¯›å›Šç‹€æ³æœƒæœ‰ä¸åŒç—›æ„Ÿã€‚' },
                    { q: 'ä»€éº¼æƒ…æ³ä¸èƒ½åšç†±è Ÿï¼Ÿ', a: 'ç¦å¿Œç—‡ï¼ˆä¸å¯é ç´„ï¼‰ï¼šæ›¬å‚·ï½œæ›è†šï½œåš´é‡éœè„ˆæ›²å¼µï½œæ€§ç—…åŠå…¶ä»–å‚³æŸ“æ€§ç–¾ç—…ï½œç—˜ç—˜è—¥ç‰©ä¸­ï½œ12 é€±å…§æˆ– 35 é€±ä»¥ä¸Šä¹‹å­•å©¦ã€‚é ˆé†«ç”ŸåŒæ„ï¼šç³–å°¿ç—…ï½œæŠ—ç”Ÿç´ ä¸­ï½œå…ç–«åŠ›å¤±èª¿ï½œé¿å­•è—¥/è·çˆ¾è’™æ²»ç™‚ã€‚' },
                    { q: 'è¡“å¾Œéœ€è¦ç‰¹åˆ¥åšä»€éº¼ä¿é¤Šå—ï¼Ÿ', a: 'é™¤æ¯›å‰å¾Œè«‹å‹¤å‹å¯†é›†ä¿æ¿•ï¼Œé™¤æ¯›ä¸€é€±å¾Œå»è§’è³ªï¼Œæœ‰åŠ©æ–¼æ–°æ¯›é«®åŠé¿å…å…§å´æ¯›ç‹€æ³ï¼Œè«‹æ³¨æ„ç”¢å“ä¸èƒ½å«é…¸ã€ä¹Ÿæ²’æœ‰ç¾ç™½åŠŸèƒ½ã€‚' },
                ]},
            ];

            let html = `
                <h2 class="text-2xl font-extrabold text-pink-700 mb-6 text-center">å¸¸è¦‹å•é¡Œ Q&A</h2>
            `;

            qaData.forEach(section => {
                html += `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-pink-600 mb-4 border-l-4 border-pink-500 pl-3">${section.category}</h3>
                        <div class="space-y-4">
                            ${section.items.map(item => `
                                <div class="p-4 bg-pink-50 rounded-xl shadow-sm">
                                    <p class="font-bold text-gray-800 flex items-start"><span class="text-red-500 mr-2">Q:</span> ${item.q}</p>
                                    <p class="text-gray-600 mt-1 flex items-start"><span class="text-green-600 mr-2">A:</span> ${item.a}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('tab-content').innerHTML = html;
        }

        /** æ¸²æŸ“æœ¬æœˆæ´»å‹•å…§å®¹ (Admin ç·¨è¼¯æ¨¡å¼æˆ–æ™®é€šé¡¯ç¤º) */
        function renderEventsContent() {
            const content = window.eventsData;
            let html = '';

            const listToHtml = (text) => {
                const items = text.split('\n').filter(line => line.trim() !== '');
                return `
                    <ul class="space-y-4">
                        ${items.map(item => `
                            <li class="flex items-start space-x-3 p-3 bg-pink-50 rounded-xl shadow-sm">
                                <span class="text-pink-600 flex-shrink-0 mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gift"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v9"/><path d="M5 12v9"/><path d="M22 8c0-3.37-2.68-6-6-6-3.32 0-6 2.68-6 6"/><path d="M2 8c0-3.37 2.68-6 6-6 3.32 0 6 2.68 6 6"/></svg>
                                </span>
                                <span class="text-gray-700 font-medium">${item.replace(/^\*\s*/, '')}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            };

            if (window.isAdmin) {
                // ç®¡ç†å“¡ç·¨è¼¯æ¨¡å¼
                html = `
                    <h2 class="admin-section-title">ç·¨è¼¯æœ¬æœˆæ´»å‹•</h2>
                    
                    <div class="mb-8">
                        <label for="edit-events-content" class="block text-lg font-semibold text-pink-700 mb-2">æ´»å‹•å…§å®¹ (æ¯è¡Œä¸€å€‹é …ç›®):</label>
                        <textarea id="edit-events-content" rows="10" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-pink-500 focus:border-pink-500">${content}</textarea>
                    </div>
                    
                    <button onclick="saveEvents()" class="btn-primary w-full sm:w-auto">å„²å­˜æ›´æ”¹</button>
                    <p class="text-sm text-gray-500 mt-2">è«‹ç¢ºä¿æ¯å€‹é …ç›®éƒ½ä»¥ "*" æˆ–å…¶ä»–ç¬¦è™Ÿé–‹é ­ï¼Œä¾¿æ–¼æ’ç‰ˆè§£æã€‚</p>
                `;
            } else {
                // æ™®é€šé¡¯ç¤ºæ¨¡å¼
                html = `
                    <h2 class="text-2xl font-extrabold text-pink-700 mb-6 text-center">ğŸ‰ æœ¬æœˆæ´»å‹• (12 æœˆé–‹å¹•æœˆ) ğŸ‰</h2>
                    ${listToHtml(content)}
                `;
            }

            document.getElementById('tab-content').innerHTML = html;
        }

        /** æ¸²æŸ“é ç´„è¡¨å–® */
        function renderBookingForm() {
            // æ‰€æœ‰ç†±è Ÿé™¤æ¯›é …ç›®
            const services = [
                'æ¯”åŸºå°¼é™¤æ¯›', 'å·´è¥¿å¼å…¨é™¤', 'è…‹ä¸‹', 'ä¸Š/ä¸‹æ‰‹è‡‚', 'å…¨æ‰‹è‡‚', 'æ‰‹æŒ‡', 
                'å°è…¿', 'å¤§è…¿', 'å…¨è…¿', 'è†è“‹', 'è‚šå­', 'ä¸Š/ä¸‹èƒŒ', 'å…¨èƒŒ'
            ];
            // é ç´„æ™‚é–“æ®µ
            const timeSlots = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00', '24:00'];
            
            // æ‰¾å‡ºå·²é ç´„çš„æ™‚æ®µ (Date+Time Slot)
            const bookedSlots = new Set();
            window.appointments.forEach(appt => {
                const key = `${appt.date}-${appt.timeSlot}`;
                bookedSlots.add(key);
            });
            
            // ç”Ÿæˆæ—¥æ›† HTML
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let calendarHtml = '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(currentYear, currentMonth, i);
                const formattedDate = formatDate(date);
                const isPast = date < today.setDate(today.getDate() - 1);
                
                // æª¢æŸ¥é€™ä¸€å¤©æ˜¯å¦æ‰€æœ‰æ™‚æ®µéƒ½è¢«é ç´„èµ° (8å€‹æ™‚æ®µéƒ½è¢«é ç´„)
                let dayFullyBooked = true;
                for (const slot of timeSlots) {
                    if (!bookedSlots.has(`${formattedDate}-${slot}`)) {
                        dayFullyBooked = false;
                        break;
                    }
                }

                const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
                
                calendarHtml += `
                    <button 
                        type="button" 
                        data-date="${formattedDate}" 
                        onclick="selectDate('${formattedDate}', this)" 
                        ${isPast || dayFullyBooked ? 'disabled' : ''}
                        class="calendar-day 
                            w-full h-12 flex flex-col items-center justify-center 
                            rounded-lg border-2 font-semibold 
                            ${dayFullyBooked ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 
                                (isPast ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 
                                'bg-white text-gray-700 border-pink-300 hover:bg-pink-100 hover:border-pink-500 transition duration-150')}
                            ${dayOfWeek === 0 || dayOfWeek === 6 ? 'text-red-500' : ''}
                        "
                    >
                        ${i}
                        <span class="text-[10px] font-normal">${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dayOfWeek]}</span>
                    </button>
                `;
            }
            
            let html = `
                <h2 class="text-2xl font-extrabold text-pink-700 mb-6 text-center">ğŸ“… é ç´„è¡¨å–®</h2>
                <form id="booking-form" onsubmit="submitBookingForm(event)">
                    
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700">å§“å <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-pink-500 focus:border-pink-500" required>
                    </div>

                    <div class="mb-4">
                        <label for="service" class="block text-sm font-medium text-gray-700">é ç´„é …ç›® <span class="text-red-500">*</span></label>
                        <select id="service" name="service" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-pink-500 focus:border-pink-500" required>
                            <option value="">è«‹é¸æ“‡ç†±è Ÿé™¤æ¯›é …ç›®</option>
                            ${services.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>

                    <!-- é ç´„æ—¥æœŸ (æœˆæ›†) -->
                    <div class="mb-6 p-4 bg-pink-50 rounded-xl">
                        <label class="block text-sm font-bold text-pink-700 mb-3">é ç´„æ—¥æœŸ (æœ¬æœˆ) <span class="text-red-500">*</span></label>
                        <p class="text-center font-bold text-lg mb-3">${currentYear} å¹´ ${currentMonth + 1} æœˆ</p>
                        <div class="grid grid-cols-7 gap-2">
                            ${calendarHtml}
                        </div>
                        <input type="hidden" id="selected-date" name="date" required>
                        <p id="date-selection-msg" class="text-center text-sm text-pink-500 mt-2 font-medium">è«‹é»é¸ä¸Šæ–¹çš„æ—¥æœŸ</p>
                    </div>

                    <!-- é ç´„æ™‚é–“æ®µ -->
                    <div class="mb-6 p-4 bg-pink-50 rounded-xl">
                        <label class="block text-sm font-bold text-pink-700 mb-3">é ç´„æ™‚é–“æ®µ <span class="text-red-500">*</span></label>
                        <div id="time-slots-container" class="grid grid-cols-4 gap-2">
                            ${timeSlots.map(slot => `
                                <button type="button" data-slot="${slot}" onclick="selectTimeSlot('${slot}', this)" class="time-slot-btn bg-white text-gray-700 border border-pink-300 rounded-lg py-2 hover:bg-pink-100 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed" disabled>
                                    ${slot}
                                </button>
                            `).join('')}
                        </div>
                        <input type="hidden" id="selected-time-slot" name="timeSlot" required>
                        <p class="text-xs text-gray-500 mt-2">è«‹å…ˆé¸æ“‡æ—¥æœŸï¼Œå†é¸æ“‡æ™‚é–“æ®µã€‚</p>
                    </div>
                    
                    <!-- é™„åŠ å•é¡Œ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">æ˜¯å¦ç‚ºå­¸ç”Ÿèº«ä»½ï¼Ÿ</label>
                        <div class="flex space-x-4 mt-1">
                            <label class="inline-flex items-center"><input type="radio" name="isStudent" value="æ˜¯" class="form-radio text-pink-600" onchange="toggleStudentTip(true)"> æ˜¯</label>
                            <label class="inline-flex items-center"><input type="radio" name="isStudent" value="å¦" class="form-radio text-pink-600" checked onchange="toggleStudentTip(false)"> å¦</label>
                        </div>
                        <p id="student-tip" class="text-sm text-yellow-600 bg-yellow-100 p-2 rounded-lg mt-2 hidden">ç•¶å¤©è«‹å¹«æˆ‘å¸¶å­¸ç”Ÿè­‰å–”ï¼</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">æ˜¯å¦æ›¾ç¶“é ç´„æœªåˆ°ï¼Ÿ</label>
                        <div class="flex space-x-4 mt-1">
                            <label class="inline-flex items-center"><input type="radio" name="didNoShow" value="æ˜¯" class="form-radio text-pink-600" onchange="toggleNoShowTip(true)"> æ˜¯</label>
                            <label class="inline-flex items-center"><input type="radio" name="didNoShow" value="å¦" class="form-radio text-pink-600" checked onchange="toggleNoShowTip(false)"> å¦</label>
                        </div>
                        <p id="noshow-tip" class="text-sm text-red-600 bg-red-100 p-2 rounded-lg mt-2 hidden">éœ€è¦è¯çµ¡ LINE å®˜æ–¹åŒ¯æ¬¾è¨‚é‡‘å–”ï¼</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700">æ˜¯å¦é¡˜æ„æˆç‚ºæ¨¡ç‰¹å…’ï¼Ÿ</label>
                        <div class="flex space-x-4 mt-1">
                            <label class="inline-flex items-center"><input type="radio" name="isModel" value="æ˜¯" class="form-radio text-pink-600" onchange="toggleModelTip(true)"> æ˜¯</label>
                            <label class="inline-flex items-center"><input type="radio" name="isModel" value="å¦" class="form-radio text-pink-600" checked onchange="toggleModelTip(false)"> å¦</label>
                        </div>
                        <p id="model-tip" class="text-sm text-blue-600 bg-blue-100 p-2 rounded-lg mt-2 hidden">æ¨¡ç‰¹å…’å¦æœ‰è¶…å„ªæƒ åƒ¹æ ¼ï¼Œéœ€é…åˆç¾å ´æ‹ä½œå“é›†ä¸¦ä¸Šå‚³åˆ°ç¤¾ç¾¤å–”ï¼(ä¸æœƒçœ‹å‡ºæ˜¯æœ¬äºº)</p>
                    </div>

                    <button type="submit" class="btn-primary w-full text-lg">é€å‡ºé ç´„</button>
                </form>
            `;
            document.getElementById('tab-content').innerHTML = html;
            
            // é‡æ–°æ‡‰ç”¨æ—¥æœŸå’Œæ™‚é–“é¸æ“‡å™¨çš„é‚è¼¯
            document.querySelectorAll('.calendar-day:not([disabled])').forEach(btn => {
                btn.addEventListener('click', () => {
                    updateTimeSlotsAvailability(btn.dataset.date);
                });
            });
            // ç¢ºä¿è¡¨å–®æç¤ºæ¡†ç‹€æ…‹æ­£ç¢º
            toggleStudentTip(document.querySelector('input[name="isStudent"]:checked').value === 'æ˜¯');
            toggleNoShowTip(document.querySelector('input[name="didNoShow"]:checked').value === 'æ˜¯');
            toggleModelTip(document.querySelector('input[name="isModel"]:checked').value === 'æ˜¯');
        }
        
        // --- Booking Form Helper Functions ---

        /** æ—¥æœŸé¸æ“‡é‚è¼¯ */
        window.selectDate = (date, element) => {
            document.getElementById('selected-date').value = date;
            document.getElementById('date-selection-msg').textContent = `å·²é¸æ“‡ï¼š${date}`;
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
            document.querySelectorAll('.calendar-day').forEach(btn => {
                btn.classList.remove('bg-pink-600', 'text-white', 'border-pink-600');
            });
            // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            element.classList.add('bg-pink-600', 'text-white', 'border-pink-600');
            
            // æ›´æ–°æ™‚é–“æ®µå¯ç”¨æ€§
            updateTimeSlotsAvailability(date);
            
            // æ¸…é™¤å·²é¸æ“‡æ™‚é–“æ®µ
            document.getElementById('selected-time-slot').value = '';
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('bg-pink-600', 'text-white');
            });
        };

        /** æ›´æ–°æ™‚é–“æ®µæŒ‰éˆ•çš„å¯ç”¨æ€§ */
        function updateTimeSlotsAvailability(date) {
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const timeSlotButtons = timeSlotsContainer.querySelectorAll('.time-slot-btn');

            timeSlotButtons.forEach(btn => {
                const slot = btn.dataset.slot;
                const key = `${date}-${slot}`;
                const isBooked = window.appointments.some(appt => appt.date === date && appt.timeSlot === slot);
                
                btn.disabled = isBooked;
                btn.classList.toggle('bg-gray-300', isBooked);
                btn.classList.toggle('text-gray-500', isBooked);
                btn.classList.toggle('cursor-not-allowed', isBooked);
                btn.classList.toggle('bg-white', !isBooked);
                btn.classList.toggle('text-gray-700', !isBooked);
            });
        }
        
        /** æ™‚é–“æ®µé¸æ“‡é‚è¼¯ */
        window.selectTimeSlot = (slot, element) => {
            if (element.disabled) return;

            document.getElementById('selected-time-slot').value = slot;
            
            // ç§»é™¤æ‰€æœ‰æ™‚é–“æŒ‰éˆ•çš„ active æ¨£å¼
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('bg-pink-600', 'text-white');
            });
            // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            element.classList.add('bg-pink-600', 'text-white');
        };

        /** å­¸ç”Ÿèº«ä»½æç¤ºæ¡† */
        window.toggleStudentTip = (show) => {
            document.getElementById('student-tip').classList.toggle('hidden', !show);
        };
        /** é ç´„æœªåˆ°æç¤ºæ¡† */
        window.toggleNoShowTip = (show) => {
            document.getElementById('noshow-tip').classList.toggle('hidden', !show);
        };
        /** æ¨¡ç‰¹å…’æç¤ºæ¡† */
        window.toggleModelTip = (show) => {
            document.getElementById('model-tip').classList.toggle('hidden', !show);
        };

        /** é€å‡ºé ç´„è¡¨å–® */
        window.submitBookingForm = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // å†æ¬¡æª¢æŸ¥é ç´„æ™‚æ®µæ˜¯å¦è¢«æ¶èµ°
            const key = `${data.date}-${data.timeSlot}`;
            const isBooked = window.appointments.some(appt => appt.date === data.date && appt.timeSlot === data.timeSlot);
            
            if (isBooked) {
                window.showMessageModal('é ç´„å¤±æ•—', 'æ‚¨é¸æ“‡çš„æ™‚æ®µå‰›å¥½è¢«é ç´„èµ°å›‰ï¼Œè«‹é‡æ–°é¸æ“‡ï¼');
                updateTimeSlotsAvailability(data.date); // æ›´æ–° UI
                return;
            }

            const appointmentsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', APPOINTMENT_COLLECTION);
            
            try {
                await addDoc(appointmentsColRef, {
                    ...data,
                    userId: window.userId,
                    createdAt: serverTimestamp(),
                    status: 'Pending'
                });
                
                form.reset();
                window.showMessageModal('é ç´„æˆåŠŸ', 'æ‚¨çš„é ç´„å·²é€å‡ºï¼æˆ‘å€‘æœƒç›¡å¿«é€é LINE èˆ‡æ‚¨ç¢ºèªç´°ç¯€ã€‚');
                renderContent('booking'); // åˆ·æ–°è¡¨å–®ï¼Œæ›´æ–°å¯ç”¨æ™‚æ®µ
            } catch (e) {
                console.error("Booking submission failed:", e);
                window.showMessageModal('éŒ¯èª¤', 'é ç´„é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–èˆ‡åº—å®¶è¯ç¹«ã€‚');
            }
        };

        /** æ¸²æŸ“é ç´„æ™‚åˆ»è¡¨ (ç®¡ç†å“¡å°ˆç”¨) */
        function renderScheduleContent() {
            if (!window.isAdmin) {
                document.getElementById('tab-content').innerHTML = `<p class="text-xl text-red-500 text-center py-10">âŒ åƒ…é™ç®¡ç†å“¡å­˜å–æ­¤é é¢ âŒ</p>`;
                return;
            }

            if (window.appointments.length === 0) {
                 document.getElementById('tab-content').innerHTML = `
                    <h2 class="admin-section-title">é ç´„æ™‚åˆ»è¡¨</h2>
                    <p class="text-gray-500 text-center py-10">ç›®å‰æ²’æœ‰ä»»ä½•é ç´„è³‡æ–™ã€‚</p>
                 `;
                 return;
            }

            // æŒ‰æ—¥æœŸå’Œæ™‚é–“æ’åº
            const sortedAppointments = [...window.appointments].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.timeSlot}`);
                const dateB = new Date(`${b.date} ${b.timeSlot}`);
                return dateA - dateB;
            });

            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedAppointments = sortedAppointments.reduce((acc, appt) => {
                (acc[appt.date] = acc[appt.date] || []).push(appt);
                return acc;
            }, {});

            let html = `<h2 class="admin-section-title">é ç´„æ™‚åˆ»è¡¨ (å…± ${window.appointments.length} ç­†)</h2>`;

            // æ¸²æŸ“è¡¨æ ¼
            for (const date in groupedAppointments) {
                const dailyAppointments = groupedAppointments[date];
                html += `
                    <div class="mb-8 p-4 bg-pink-50 rounded-xl shadow-lg border border-pink-100">
                        <h3 class="text-lg font-bold text-pink-700 mb-3">${date}</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-gray-700 bg-white rounded-lg">
                                <thead>
                                    <tr class="text-left">
                                        <th class="p-3 border-b-2 border-pink-200">æ™‚é–“</th>
                                        <th class="p-3 border-b-2 border-pink-200">å§“å</th>
                                        <th class="p-3 border-b-2 border-pink-200">é …ç›®</th>
                                        <th class="p-3 border-b-2 border-pink-200">å­¸ç”Ÿ/æœªåˆ°/æ¨¡ç‰¹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dailyAppointments.map(appt => `
                                        <tr class="hover:bg-pink-50 transition-colors">
                                            <td class="p-3 border-b border-pink-100 font-semibold">${appt.timeSlot}</td>
                                            <td class="p-3 border-b border-pink-100">${appt.name}</td>
                                            <td class="p-3 border-b border-pink-100 text-pink-600">${appt.service}</td>
                                            <td class="p-3 border-b border-pink-100 text-xs">
                                                ${appt.isStudent === 'æ˜¯' ? '<span class="bg-yellow-100 text-yellow-800 p-1 rounded">å­¸ç”Ÿ</span>' : ''}
                                                ${appt.didNoShow === 'æ˜¯' ? '<span class="bg-red-100 text-red-800 p-1 rounded ml-1">æ›¾æœªåˆ°</span>' : ''}
                                                ${appt.isModel === 'æ˜¯' ? '<span class="bg-blue-100 text-blue-800 p-1 rounded ml-1">æ¨¡ç‰¹å…’</span>' : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            document.getElementById('tab-content').innerHTML = html;
        }

        // --- Tab Control ---

        /** åˆ‡æ›åˆ†é é‚è¼¯ */
        window.changeTab = (tabName) => {
            window.activeTab = tabName;

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // æ¸²æŸ“å…§å®¹
            switch (tabName) {
                case 'rules':
                    renderRulesContent();
                    break;
                case 'prices':
                    renderPricesContent();
                    break;
                case 'qa':
                    renderQAContent();
                    break;
                case 'events':
                    renderEventsContent();
                    break;
                case 'booking':
                    renderBookingForm();
                    break;
                case 'schedule':
                    renderScheduleContent();
                    break;
                default:
                    document.getElementById('tab-content').innerHTML = '<p class="text-center text-gray-500 py-10">å…§å®¹è¼‰å…¥éŒ¯èª¤ã€‚</p>';
            }
        };

        // å•Ÿå‹•æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
        });
    </script>
</body>
</html>
